@using MyHebrewBible.Client.Enums
@using MyHebrewBible.Client.Layout

<div class="d-flex mb-3">
	<div class="me-auto p-2">

		<BlazoredTypeahead SearchMethod="SearchBibleBooks"
											 TValue="BibleBook"
											 TItem="BibleBook"
											 Value="SelectedBook"
											 ValueChanged="SelectedResultChanged"
											 ValueExpression="@(() => SelectedBook)"
											 EnableDropDown="true"
											 MaximumSuggestions="66"
											 MinimumLength="1"
											 placeholder="Search bible...">
			<SelectedTemplate Context="mycontext">
				@if (MediaQuery == MediaQuery.Xs)
				{
					@mycontext!.Title
				}
				else
				{
					<span>@mycontext!.Title</span> <text>&nbsp;&nbsp;&nbsp;</text>
					<span class="hebrew">@mycontext.NameInHebrew</span>
				}
			</SelectedTemplate>
			<HelpTemplate>
				Please enter at least 1 characters to perform a search.
			</HelpTemplate>
			<ResultTemplate Context="mycontext">
				@if (MediaQuery == MediaQuery.Xs)
				{
					@mycontext!.Title
				}
				else
				{
					<div class="d-flex justify-content-between">
						@mycontext!.Title <span class="hebrew">@mycontext.NameInHebrew</span>
					</div>
				}
			</ResultTemplate>
		</BlazoredTypeahead>
	</div>

	<div class="p-1">
		<a href="/" class="btn btn-primary" title="Customize book chapter settings">
			<i class="fas fa-cog"></i>
		</a>
	</div>

</div>

@if (ShowChapterButtons)
{
	@if (SelectedBook != null)
	{
		<div class="d-flex mt-3">
			<ChapterButtons CurrentBibleBook="@SelectedBook"
											ButtonsPerRow="ButtonsPerRow"
											OnChapterFilterSelected="OnChapterSelected" />
		</div>
	}
}

@if (ShowVerseButtons)
{
 	<div class="d-flex mt-3">

		 <VerseButtons VerseCount="VerseCount"
			 ButtonsPerRow="ButtonsPerRow" 
			 OnVerseFilterSelected="OnVerseSelected" />
	</div>
} 
 

@code {
	[Parameter, EditorRequired] public MediaQuery? MediaQuery { get; set; }
	[Parameter] public EventCallback<BookChapterVerseVM> OnBookAndChapterSelected { get; set; }

	public BookChapterVerseVM? CurrentBookChapterVerseVM { get; set; }

	protected int ButtonsPerRow;
	protected bool ShowChapterButtons = false; 
	protected BibleBook? SelectedBook { get; set; }
	protected int VerseCount { get; set; }

	protected bool ShowVerseButtons = false;

	protected override void OnParametersSet()
	{
		// if (BookAndChapterTypeahead is not null && BookAndChapterTypeahead.BibleBook is not null)
		// {
		// 	BibleBookGottenFromParent = BookAndChapterTypeahead!.BibleBook;
		// 	SelectedBook = BookAndChapterTypeahead!.BibleBook;
		// }
		if (MediaQuery is not null) { SetMediaQuery(); }
	}

	private void OnChapterSelected(BookChapterVerseVM bookChapterVerseVM)
	{
		CurrentBookChapterVerseVM = bookChapterVerseVM;
		ShowChapterButtons = false;
		ShowVerseButtons = true;
		VerseCount = bookChapterVerseVM.BibleBook!.LastVerses[bookChapterVerseVM.Chapter - 1];
	}

	private void OnVerseSelected(int verse)
	{
		ShowChapterButtons = false;
		ShowVerseButtons = false;
		BookChapterVerseVM bookChapterVerseVM = new(CurrentBookChapterVerseVM!.BibleBook, CurrentBookChapterVerseVM.Chapter, verse);
		OnBookAndChapterSelected.InvokeAsync(bookChapterVerseVM);
	}

	private async Task<IEnumerable<BibleBook>> SearchBibleBooks(string searchText)
	{
		return await Task.FromResult(BibleBook.List
			.Where(x => x.Title.ToLower().Contains(searchText.ToLower()))
			.OrderBy(o => o.Value));
	}

	private void SelectedResultChanged(BibleBook result)
	{
		ShowChapterButtons = true;
		SelectedBook = result;
	}

	private void SetMediaQuery()
	{
		MediaQuery!
		.When(MediaQuery.Xs).Then(() => ButtonsPerRow = 5)
		.When(MediaQuery.Sm).Then(() => ButtonsPerRow = 10)
		.When(MediaQuery.Md).Then(() => ButtonsPerRow = 15)
		.When(MediaQuery.Lg).Then(() => ButtonsPerRow = 20)
		.When(MediaQuery.Xl).Then(() => ButtonsPerRow = 25);

	}
}
