@using Page = MyHebrewBible.Client.Enums.Nav
@using ParashaEnums = MyHebrewBible.Client.Features.Parasha.Enums
@using MyHebrewBible.Client.Helpers
@using NumberPadBCV = MyHebrewBible.Client.Features.BookChapter.Toolbar.NumberPad

@inject NavigationManager NavigationManager
@inject ILogger<HomeDropdown>? Logger
@inject IToastService? Toast

<div class="btn-group " role="group" aria-label="Vertical button group">

	<button @onclick="ButtonClickHome" class="btn btn-primary btn-md" title="@Page.Home.Title">
		<i class="@Page.Home.Icon"></i>
	</button>

	<button type="button" class="btn btn-info btn-md dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
		<span class="visually-hidden">Toggle Dropdown</span>
	</button>

	@if (RecentList is not null && RecentList.Any())
	{
		<ul class="dropdown-menu">
			<li><h5 class="dropdown-header"><b>Recent</b></h5></li>
			@foreach (var item in RecentList)
			{
				<li class="dropdown-item">
					<a @onclick="@(e => ButtonClick(item))">
						@GlobalEnums.BibleBook.FromValue(item.BibleBookId).Abrv @item.Chapter:@item.Verse
					</a>
				</li>
			}

			<li><hr class="dropdown-divider"></li>

		</ul>
	}
	else
	{
		<ul class="dropdown-menu">
			@* <li class="dropdown-item">--No BCV--</li> *@
			<li class="dropdown-item">
				<a @onclick="ButtonClickRefresh" class="fw-bold">
					Refresh
					<i class="fas fa-sync-alt"></i>
				</a>
			</li>
		</ul>
	}



	@if (ParashaList is not null && ParashaList.Any())
	{
		<ul class="dropdown-menu">
			<li><h5 class="dropdown-header"><b>Parasha</b></h5></li>
			@foreach (var item in ParashaList)
			{
				<li class="dropdown-item">
					<a @onclick="@(e => ButtonClick(item))">
						@GlobalEnums.BibleBook.FromValue(item.BibleBookId).Abrv @item.Chapter:@item.Verse
					</a>
				</li>
			}
		</ul>
	}
	else
	{
		<ul class="dropdown-menu">
			<li class="dropdown-item">--No Parasha--</li>
		</ul>
	}

</div>


@code {
	[Parameter] public EventCallback<NumberPadBCV.BookChapterVerse> OnBCVSelected { get; set; }
	[CascadingParameter] public CascadingAppState? CascadingAppState { get; set; }

	string headerColor => TextColors.Success;
	private string? ButtonText;

	protected List<BookChapterVerseHistory>? RecentList = new();
	protected List<BookChapterVerseHistory>? ParashaList = new();


	protected bool ShowParashaList = false;

	protected override void OnInitialized()
	{
		try
		{
			RecentList = CascadingAppState!.AppState!.BookChapterState!.GetBCVs();
			//ParashaList = LoadParasha();
		}
		catch (Exception ex)
		{
			Logger!.LogError(ex, "{Method}", nameof(OnInitialized));
			Toast!.ShowError($"{Global.ToastShowError} {nameof(Index)}!{nameof(OnInitialized)}");
		}
	}

	private void ButtonClickRefresh()
	{
		try
		{
			if (RecentList is null)
			{
				Toast!.ShowWarning($"RecentList IS NULL");
			}
			else
			{
				Toast!.ShowInfo($"Before Count: {RecentList.Count}");
			}

			RecentList = CascadingAppState!.AppState!.BookChapterState!.GetBCVs();
			Toast!.ShowInfo($"After Count: {RecentList.Count}");
		}
		catch (Exception ex)
		{
			Logger!.LogError(ex, "{Method}", nameof(ButtonClickRefresh));
			Toast!.ShowError($"{Global.ToastShowError} {nameof(Index)}!{nameof(ButtonClickRefresh)}");
		}
	}

	private void ButtonClickHome()
	{
		//ToDo: Should I call await CascadingAppState!.AppState!.BookChapterState!.AddStoredAcvToBcvList();???
		NavigationManager!.NavigateTo($"{Page.Home.Index}");
	}

	private async Task ButtonClick(BookChapterVerseHistory bcv)
	{
		await CascadingAppState!.AppState!.BookChapterState!.AddStoredAcvToBcvList();
		await OnBCVSelected.InvokeAsync(new NumberPadBCV.BookChapterVerse(GlobalEnums.BibleBook.FromValue(bcv.BibleBookId), bcv.Chapter, bcv.Verse));
	}
}
